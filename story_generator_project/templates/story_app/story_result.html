{% extends 'base.html' %}

{% block title %}Your Generated Story{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="fas fa-book"></i> Your Generated Story</h2>
            <a href="{% url 'index' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Generate New Story
            </a>
        </div>

        <!-- Audio Input Information -->
        {% if story_obj.has_audio %}
        <div class="card shadow-lg mb-4 border-info">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-microphone"></i> Audio Input
                </h4>
                <div class="btn-group">
                    <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse"
                        data-bs-target="#audioDetails" aria-expanded="false">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                    {% if story_obj.audio_file %}
                    <a href="{% url 'download_audio_file' story_obj.id %}" class="btn btn-light btn-sm">
                        <i class="fas fa-download"></i> Download Audio
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <!-- Audio Player -->
                {% if story_obj.audio_file_url %}
                <div class="mb-3">
                    <label class="form-label"><strong>Original Audio:</strong></label>
                    <audio controls class="w-100">
                        <source src="{{ story_obj.audio_file_url }}" type="audio/mpeg">
                        Your browser does not support audio playback.
                    </audio>
                </div>
                {% endif %}

                <!-- Audio Transcription -->
                {% if story_obj.audio_transcription %}
                <div class="mb-3">
                    <label class="form-label"><strong>Transcription:</strong></label>
                    <div class="bg-light p-3 rounded">
                        <i class="fas fa-quote-left text-muted"></i>
                        {{ story_obj.audio_transcription }}
                        <i class="fas fa-quote-right text-muted"></i>
                    </div>
                </div>
                {% endif %}

                <!-- Collapsible Audio Details -->
                <div class="collapse" id="audioDetails">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-info-circle"></i> Audio Metadata</h6>
                            {% if story_obj.audio_duration > 0 %}
                            <p class="mb-1"><strong>Duration:</strong> {{ story_obj.audio_duration|floatformat:1 }} seconds</p>
                            {% endif %}
                            <p class="mb-1"><strong>Input Type:</strong> {{ story_obj.input_type_display }}</p>
                            <p class="mb-0"><strong>Processing:</strong> OpenAI Whisper transcription</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-cogs"></i> Transcription Quality</h6>
                            <p class="mb-1"><strong>Characters:</strong> {{ story_obj.audio_transcription|length }}</p>
                            <p class="mb-1"><strong>Words:</strong> ~{{ story_obj.audio_transcription|wordcount }}</p>
                            <p class="mb-0"><strong>Status:</strong> 
                                <span class="badge bg-success">Transcribed Successfully</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Combined Scene Section -->
        {% if story_obj.has_combined_scene %}
        <div class="card shadow-lg mb-4 border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-image"></i> Complete Scene
                </h4>
                <div class="btn-group">
                    <button class="btn btn-light btn-sm" type="button" data-bs-toggle="collapse"
                        data-bs-target="#sceneDetails" aria-expanded="false">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                    <a href="{% url 'download_combined_scene' story_obj.id %}" class="btn btn-light btn-sm">
                        <i class="fas fa-download"></i> Download
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="text-center position-relative">
                    <img src="{{ story_obj.combined_scene_url }}" alt="Complete Story Scene"
                        class="img-fluid w-100" style="max-height: 500px; object-fit: contain;">
                    
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-dark bg-opacity-75">
                            <i class="fas fa-layer-group"></i> Combined Scene
                        </span>
                        {% if story_obj.has_audio %}
                        <span class="badge bg-info bg-opacity-75 ms-1">
                            <i class="fas fa-microphone"></i> From Audio
                        </span>
                        {% endif %}
                    </div>
                </div>

                <div class="collapse" id="sceneDetails">
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-palette"></i> Composition Info</h6>
                                <p class="mb-1"><strong>Layout:</strong> {{ story_obj.composition_summary }}</p>
                                <p class="mb-1"><strong>Compositor:</strong> {{ story_obj.combined_scene_model }}</p>
                                {% if story_obj.combined_scene_prompt %}
                                <p class="mb-0"><strong>Process:</strong> {{ story_obj.combined_scene_prompt }}</p>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-cogs"></i> Source Information</h6>
                                <p class="mb-1"><strong>Story Source:</strong> {{ story_obj.input_type_display }}</p>
                                <p class="mb-1"><strong>Style Matching:</strong> Color temperature & lighting adjusted</p>
                                <p class="mb-0"><strong>Enhancement:</strong> {{ story_obj.genre_display }} genre effects</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Story Content -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-book-open"></i> Story</h4>
                    <div>
                        {% if story_obj.input_type == 'audio' %}
                        <span class="badge bg-info">
                            <i class="fas fa-microphone"></i> Generated from Audio
                        </span>
                        {% elif story_obj.input_type == 'both' %}
                        <span class="badge bg-success">
                            <i class="fas fa-plus"></i> Text + Audio Input
                        </span>
                        {% else %}
                        <span class="badge bg-secondary">
                            <i class="fas fa-keyboard"></i> Text Input
                        </span>
                        {% endif %}
                    </div>
                </div>
                {% if story_obj.effective_prompt %}
                <small class="d-block mt-1">
                    <strong>Based on:</strong> "{{ story_obj.effective_prompt|truncatechars:100 }}"
                </small>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="story-text">
                    {{ story_obj.generated_story|linebreaksbr }}
                </div>
            </div>
        </div>

        <!-- Individual Images Section -->
        {% if story_obj.has_character_image or story_obj.has_background_image %}
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-images"></i> Individual Components</h4>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="imageTab" role="tablist">
                    {% if story_obj.has_character_image %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="character-tab" data-bs-toggle="tab"
                            data-bs-target="#character" type="button" role="tab">
                            <i class="fas fa-user"></i> Character
                        </button>
                    </li>
                    {% endif %}
                    {% if story_obj.has_background_image %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if not story_obj.has_character_image %}active{% endif %}" 
                            id="environment-tab" data-bs-toggle="tab" data-bs-target="#environment" type="button" role="tab">
                            <i class="fas fa-mountain"></i> Environment
                        </button>
                    </li>
                    {% endif %}
                </ul>

                <div class="tab-content" id="imageTabContent">
                    <!-- Character Tab -->
                    {% if story_obj.has_character_image %}
                    <div class="tab-pane fade show active" id="character" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-md-4">
                                <div class="text-center">
                                    <img src="{{ story_obj.character_image_url }}" alt="Character Portrait"
                                        class="img-fluid rounded shadow" style="max-width: 300px; max-height: 400px;">
                                    {% if story_obj.character_image_model %}
                                    <small class="text-muted d-block mt-2">
                                        Generated with: {{ story_obj.character_image_model|truncatechars:30 }}
                                    </small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-8">
                                <h6>Character Description</h6>
                                {{ story_obj.character_description|linebreaksbr }}
                            </div>
                        </div>
                        
                        {% if story_obj.character_image_prompt %}
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse"
                                data-bs-target="#characterPrompt" aria-expanded="false">
                                <i class="fas fa-code"></i> View Generation Prompt
                            </button>
                            <div class="collapse mt-2" id="characterPrompt">
                                <div class="card card-body bg-light">
                                    <small class="text-muted">{{ story_obj.character_image_prompt }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- Environment Tab -->
                    {% if story_obj.has_background_image %}
                    <div class="tab-pane fade {% if not story_obj.has_character_image %}show active{% endif %}" 
                         id="environment" role="tabpanel">
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>Environment Description</h6>
                                {{ story_obj.background_description|linebreaksbr }}
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-12 text-center">
                                <img src="{{ story_obj.background_image_url }}" alt="Story Environment"
                                    class="img-fluid rounded shadow"
                                    style="max-width: 100%; max-height: 400px; object-fit: contain;">
                                {% if story_obj.background_image_model %}
                                <small class="text-muted d-block mt-2">
                                    Generated with: {{ story_obj.background_image_model|truncatechars:30 }}
                                </small>
                                {% endif %}
                            </div>
                        </div>

                        {% if story_obj.background_image_prompt %}
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-success" type="button" data-bs-toggle="collapse"
                                data-bs-target="#backgroundPrompt" aria-expanded="false">
                                <i class="fas fa-code"></i> View Generation Prompt
                            </button>
                            <div class="collapse mt-2" id="backgroundPrompt">
                                <div class="card card-body bg-light">
                                    <small class="text-muted">{{ story_obj.background_image_prompt }}</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Enhanced Generation Summary -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-secondary text-white">
                <h4 class="mb-0"><i class="fas fa-cog"></i> Generation Summary</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Genre:</strong> {{ genre|default:"Unknown" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Length:</strong> {{ length|default:"Unknown" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Generated:</strong> {{ story_obj.created_at|date:"M d, Y H:i" }}
                    </div>
                    <div class="col-md-3">
                        <strong>Input:</strong> {{ story_obj.input_type_display }}
                        {% if story_obj.has_audio %}
                            <i class="fas fa-microphone text-info ms-1"></i>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Audio Processing Info -->
                {% if story_obj.has_audio %}
                <div class="row mt-2">
                    <div class="col-md-3">
                        <strong>Audio Duration:</strong> {{ story_obj.audio_duration|floatformat:1 }}s
                    </div>
                    <div class="col-md-3">
                        <strong>Transcription:</strong> {{ story_obj.audio_transcription|wordcount }} words
                    </div>
                    <div class="col-md-6">
                        <strong>Processing:</strong> Whisper → LangChain → Image Generation
                    </div>
                </div>
                {% endif %}

                <div class="row mt-2">
                    <div class="col-12">
                        <strong>Images:</strong> {{ story_obj.image_generation_summary|join:", "|default:"None" }}
                    </div>
                </div>
                
                <!-- Generation Chain Process -->
                <div class="mt-3">
                    <h6><i class="fas fa-project-diagram"></i> Processing Flow</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% if story_obj.has_audio %}
                            <span class="badge bg-info">1. Audio → Text</span>
                            <i class="fas fa-arrow-right text-muted align-self-center"></i>
                            <span class="badge bg-primary">2. Story Generation</span>
                        {% else %}
                            <span class="badge bg-primary">1. Story Generation</span>
                        {% endif %}
                        <i class="fas fa-arrow-right text-muted align-self-center"></i>
                        <span class="badge bg-info">{{ story_obj.has_audio|yesno:"3,2" }}. Character Description</span>
                        <i class="fas fa-arrow-right text-muted align-self-center"></i>
                        <span class="badge bg-warning text-dark">{{ story_obj.has_audio|yesno:"4,3" }}. Environment Description</span>
                        <i class="fas fa-arrow-right text-muted align-self-center"></i>
                        <span class="badge bg-success">{{ story_obj.has_audio|yesno:"5,4" }}. Image Generation</span>
                        {% if story_obj.has_combined_scene %}
                        <i class="fas fa-arrow-right text-muted align-self-center"></i>
                        <span class="badge bg-danger">{{ story_obj.has_audio|yesno:"6,5" }}. Scene Composition</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Image Generation Status -->
                {% if image_generation_attempted %}
                <div class="mt-3">
                    <h6><i class="fas fa-chart-bar"></i> Generation Results</h6>
                    <div class="row">
                        {% if story_obj.has_audio %}
                        <div class="col-md-2">
                            <div class="text-center">
                                <i class="fas fa-check-circle text-success fa-2x"></i>
                                <small class="d-block">Audio Transcribed</small>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-{{ story_obj.has_audio|yesno:'2,3' }}">
                            <div class="text-center">
                                {% if story_obj.has_character_image %}
                                <i class="fas fa-check-circle text-success fa-2x"></i>
                                <small class="d-block">Character Image</small>
                                {% else %}
                                <i class="fas fa-times-circle text-danger fa-2x"></i>
                                <small class="d-block">Character Failed</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-{{ story_obj.has_audio|yesno:'2,3' }}">
                            <div class="text-center">
                                {% if story_obj.has_background_image %}
                                <i class="fas fa-check-circle text-success fa-2x"></i>
                                <small class="d-block">Environment Image</small>
                                {% else %}
                                <i class="fas fa-times-circle text-danger fa-2x"></i>
                                <small class="d-block">Environment Failed</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-{{ story_obj.has_audio|yesno:'2,3' }}">
                            <div class="text-center">
                                {% if story_obj.has_combined_scene %}
                                <i class="fas fa-check-circle text-success fa-2x"></i>
                                <small class="d-block">Combined Scene</small>
                                {% else %}
                                <i class="fas fa-times-circle text-warning fa-2x"></i>
                                <small class="d-block">Scene Combination</small>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-{{ story_obj.has_audio|yesno:'2,3' }}">
                            <div class="text-center">
                                {% if story_obj.has_complete_image_set %}
                                <i class="fas fa-trophy text-warning fa-2x"></i>
                                <small class="d-block">Complete Package</small>
                                {% else %}
                                <i class="fas fa-medal text-primary fa-2x"></i>
                                <small class="d-block">Partial Package</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card shadow-lg">
            <div class="card-body text-center">
                <div class="btn-group" role="group">
                    <a href="{% url 'index' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Generate New Story
                    </a>
                    {% if story_obj.has_audio and story_obj.audio_file %}
                    <a href="{% url 'download_audio_file' story_obj.id %}" class="btn btn-outline-info">
                        <i class="fas fa-download"></i> Download Audio
                    </a>
                    {% endif %}
                    {% if story_obj.has_combined_scene %}
                    <a href="{% url 'download_combined_scene' story_obj.id %}" class="btn btn-outline-success">
                        <i class="fas fa-download"></i> Download Scene
                    </a>
                    {% endif %}
                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                        <i class="fas fa-trash"></i> Delete Story
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Story</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this story and all its associated content (images{% if story_obj.has_audio %}, audio file{% endif %})? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{% url 'delete_story' story_obj.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}